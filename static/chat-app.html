<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Python Chat with Azure AI Foundry</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b1220;
      --bg-soft: rgba(255, 255, 255, 0.06);
      --panel: rgba(17, 24, 39, 0.4);
      --text: #e5e7eb;
      --subtle: #9ca3af;
      --accent: #7aa2ff;
      --accent-2: #5a7cf9;
      --success: #22c55e;
      --danger: #ef4444;
      --bubble-user: linear-gradient(135deg, #7aa2ff, #5a7cf9);
      --bubble-ai: rgba(255, 255, 255, 0.08);
      --border: rgba(255, 255, 255, 0.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --blur: blur(14px);

      /* Input/button sizing */
      --control-h: 44px;
      --control-br: 10px;
      --control-pad-x: 14px;
    }

    html[data-theme="light"] {
      --bg: #f4f6fb;
      --bg-soft: rgba(255, 255, 255, 0.8);
      --panel: rgba(255, 255, 255, 0.75);
      --text: #0f172a;
      --subtle: #64748b;
      --accent: #2563eb;
      --accent-2: #1d4ed8;
      --bubble-user: linear-gradient(135deg, #60a5fa, #2563eb);
      --bubble-ai: rgba(15, 23, 42, 0.04);
      --border: rgba(15, 23, 42, 0.08);
      --shadow: 0 15px 35px rgba(2,6,23,.12);
      --blur: blur(10px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(37, 99, 235, .25), transparent 40%),
        radial-gradient(1000px 600px at -10% 10%, rgba(34, 197, 94, .15), transparent 30%),
        var(--bg);
    }

    .wrap { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; }

    .nav {
      position: sticky; top: 0;
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      padding: 18px 20px; backdrop-filter: var(--blur); background: var(--panel);
      border-bottom: 1px solid var(--border); box-shadow: var(--shadow); z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .2px; }
    .logo {
      width: 36px; height: 36px; display: grid; place-items: center; border-radius: 11px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff; box-shadow: 0 10px 20px rgba(37,99,235,.35);
    }
    .muted { color: var(--subtle); font-weight: 500; }
    .pill {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
      background: var(--bg-soft); font-size: .88rem; color: var(--subtle);
    }
    .toggle {
      appearance: none; width: 52px; height: 30px; border-radius: 999px; position: relative;
      background: var(--bubble-ai); border: 1px solid var(--border);
      cursor: pointer; outline: none; transition: background .25s ease;
    }
    .toggle::after {
      content: ""; position: absolute; top: 50%; left: 4px; transform: translateY(-50%);
      width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(135deg, #fff, #dbeafe);
      box-shadow: 0 4px 10px rgba(0,0,0,.22);
      transition: left .25s ease;
    }
    .toggle:checked { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    .toggle:checked::after { left: 26px; }

    .container {
      width: min(1060px, 92vw);
      margin: 24px auto 28px;
      display: grid; grid-template-rows: 1fr auto;
      gap: 18px;
    }

    .chat {
      border: 1px solid var(--border); background: var(--panel);
      border-radius: 14px; box-shadow: var(--shadow); backdrop-filter: var(--blur);
      padding: 12px; display: grid; grid-template-rows: 1fr auto; /* messages grows, composer stays compact */
      min-height: 62vh; max-height: 74vh;
    }

    .messages {
      overflow: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth;
    }

    .bubble {
      max-width: 78%; padding: 12px 14px; border-radius: 14px; line-height: 1.45;
      border: 1px solid var(--border); box-shadow: 0 6px 16px rgba(0,0,0,.12);
      animation: rise .25s ease both; word-wrap: break-word; white-space: pre-wrap;
    }
    .bubble.user { align-self: flex-end; color: #fff; background: var(--bubble-user); border: none; border-bottom-right-radius: 6px; }
    .bubble.ai { align-self: flex-start; background: var(--bubble-ai); border-bottom-left-radius: 6px; }
    @keyframes rise { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* --- COMPOSER: compact, fixed-height controls --- */
    .composer {
      display: grid;
      grid-template-columns: 1fr auto auto; /* input | reset | send (side-by-side on desktop) */
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      backdrop-filter: var(--blur);
    }
    .input {
      height: var(--control-h);
      padding: 0 var(--control-pad-x);
      border: 1px solid var(--border);
      border-radius: var(--control-br);
      background: var(--bg-soft);
      color: var(--text);
      outline: none;
      font-size: 1rem;
    }
    .btn {
      height: var(--control-h);
      padding: 0 16px;
      appearance: none; border: 0; border-radius: var(--control-br);
      font-weight: 700; color: #fff; cursor: pointer; white-space: nowrap;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 16px rgba(37, 99, 235, .22);
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.03); box-shadow: 0 12px 18px rgba(37,99,235,.26); }
    .btn.secondary { background: linear-gradient(135deg, #6b7280, #4b5563); box-shadow: 0 8px 16px rgba(31,41,55,.18); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* On small screens, stack Reset and Send under the input, full width */
    @media (max-width: 640px) {
      .composer {
        grid-template-columns: 1fr;
        grid-auto-rows: var(--control-h);
      }
      .btn { width: 100%; }
    }

    .typing { display: inline-grid; grid-auto-flow: column; gap: 6px; align-items: center; color: var(--subtle); }
    .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--subtle); animation: bounce 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%,80%,100%{ transform: translateY(0); opacity:.6 } 40%{ transform: translateY(-6px); opacity:1 } }

    .footer { text-align: center; color: var(--subtle); padding: 10px 12px 30px; font-size: .92rem; }
    .hint { display: inline-flex; align-items: center; gap: 8px; font-size: .9rem; color: var(--subtle); }
    .hint .dot-green { width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 0 4px rgba(34,197,94,.15); }
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          Python AI chatbot<br />
          <span class="muted">Using an Azure AI Foundry model · Inference SDK · Managed Identity <br><i style="font-size: 80%;">by Tobias Zimmergren</i></span>
        </div>
      </div>

      <div style="display:flex; align-items:center; gap:12px;">
        <label class="pill"><span class="dot-green"></span> Connected</label>
        <label class="pill" title="Toggle dark mode">
          <span>Theme</span>
          <input id="themeToggle" type="checkbox" class="toggle" />
        </label>
      </div>
    </nav>

    <main class="container">
      <section class="chat">
        <div id="messages" class="messages">
          <div class="bubble ai">
            🤖 Hey, what can I do for you today?
          </div>
        </div>

        <form id="composer" class="composer" autocomplete="off">
          <input id="prompt" class="input" type="text" placeholder="Type a message and press Enter..." />
          <button id="send" class="btn" type="submit" title="Send (Enter)">Send</button>
          <button id="reset" class="btn secondary" type="button" title="Reset conversation">Reset</button>          
        </form>
      </section>

      <div class="footer">
        <span class="hint">Safety first: Avoid jailbreak or policy-avoidance prompts. The assistant follows Azure policies.</span>
      </div>
    </main>
  </div>

  <script>
    const $doc = document.documentElement;
    const $messages = document.getElementById('messages');
    const $prompt = document.getElementById('prompt');
    const $send = document.getElementById('send');
    const $reset = document.getElementById('reset');
    const $form = document.getElementById('composer');
    const $theme = document.getElementById('themeToggle');

    // Theme toggle + persistence
    (() => {
      const saved = localStorage.getItem('theme') || 'light';
      $doc.setAttribute('data-theme', saved);
      $theme.checked = saved === 'dark';
      $theme.addEventListener('change', () => {
        const mode = $theme.checked ? 'dark' : 'light';
        $doc.setAttribute('data-theme', mode);
        localStorage.setItem('theme', mode);
      });
    })();

    function addBubble(kind, text) {
      const el = document.createElement('div');
      el.className = 'bubble ' + (kind === 'user' ? 'user' : 'ai');
      el.textContent = text;
      $messages.appendChild(el);
      $messages.scrollTop = $messages.scrollHeight;
      return el;
    }

    function showTyping() {
      const wrap = document.createElement('div');
      wrap.className = 'bubble ai';
      wrap.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      $messages.appendChild(wrap);
      $messages.scrollTop = $messages.scrollHeight;
      return wrap;
    }

    async function sendMessage(text) {
      if (!text) return;
      addBubble('user', text);
      const typing = showTyping();
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        typing.remove();
        addBubble('ai', data.reply || '(no reply)');
      } catch (err) {
        typing.remove();
        addBubble('ai', '⚠️ Network error. Please try again.');
        console.error(err);
      }
    }

    async function resetSession() {
      const typing = showTyping();
      try {
        await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reset: true })
        });
        $messages.innerHTML = '';
        addBubble('ai', 'Session reset. How can I help?');
      } catch (err) {
        addBubble('ai', '⚠️ Failed to reset session.');
      } finally {
        typing.remove();
      }
    }

    $form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = $prompt.value.trim();
      $prompt.value = '';
      sendMessage(text);
    });

    $reset.addEventListener('click', () => resetSession());
  </script>
</body>
</html>
